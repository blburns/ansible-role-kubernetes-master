---
- name: Downloading ElasticSearch code
  git:
    repo: "https://github.com/pires/{{ item.repo }}"
    dest: "{{ item.path }}"
    update: yes
    force: yes
  with_items:
    - { repo: 'kubernetes-elasticsearch-cluster.git', path: '/tmp/kubernetes-elasticsearch-cluster' }
    - { repo: 'kubernetes-elk-cluster.git', path: '/tmp/kubernetes-elk-cluster' }

- name: Import the ElasticSearch primary services and pod
  kubernetes:
    api_endpoint: "{{ master_address }}"
    file_reference: "{{ item }}"
    state: present
  with_items:
    - "/tmp/kubernetes-elasticsearch-cluster/es-discovery-svc.yaml"
    - "/tmp/kubernetes-elasticsearch-cluster/es-svc.yaml"
    - "/tmp/kubernetes-elasticsearch-cluster/es-master.yaml"
    
- name: Import the ElasticSearch client and data storage deployments
  kubernetes:
    api_endpoint: "{{ master_address }}"
    file_reference: "{{ item }}"
    state: present
  with_items:
    - "/tmp/kubernetes-elasticsearch-cluster/es-client.yaml"
    - "/tmp/kubernetes-elasticsearch-cluster/es-data.yaml"

- name: Create the service account, logstash and kibana services and controllers
  kubernetes:
    api_endpoint: "{{ master_address }}"
    file_reference: "{{ item }}"
    state: present
  with_items:
    - "/tmp/kubernetes-elk-cluster/service-account.yaml"
    - "/tmp/kubernetes-elk-cluster/logstash-service.yaml"
    - "/tmp/kubernetes-elk-cluster/logstash-controller.yaml"
    - "/tmp/kubernetes-elk-cluster/kibana-service.yaml"
    - "/tmp/kubernetes-elk-cluster/kibana-controller.yaml"
